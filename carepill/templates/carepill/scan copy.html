
{% extends "base.html" %}
{% load static %}
{% block title %}약 투입 | CarePill{% endblock %}

{% block extra_css %}
<style>
  .scan-grid{display:grid;grid-template-columns:1.2fr 1fr;gap:24px;align-items:start}
  .cam-wrap{position:relative;background:#111;border-radius:16px;overflow:hidden}
  video{width:100%;height:auto;display:block}
  .roi{position:absolute;border:3px solid #36d399;inset:auto;pointer-events:none}
  .hud{position:absolute;left:0;right:0;top:0;padding:12px 16px;color:#fff;font-size:14px;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0))}
  .controls{display:flex;gap:12px;margin-top:12px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;font-weight:600;cursor:pointer}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .thumbs{display:flex;gap:8px;margin-top:10px}
  .thumbs img{width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #ddd}
  .result-card{background:#fff;border:1px solid #eee;border-radius:16px;padding:16px}
  .data-table{width:100%;border-collapse:collapse}
  .data-table th,.data-table td{border-bottom:1px solid #eee;padding:8px 10px;text-align:left}
  .progress{height:8px;background:#f3f3f3;border-radius:999px;overflow:hidden;margin:10px 0}
  .bar{height:100%;width:0;background:#36d399;transition:width .3s}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;white-space:pre-wrap;background:#0b1020;color:#CBE1FF;padding:10px;border-radius:10px}
</style>
{% endblock %}

{% block content %}
<section class="page-section">
  <h1 class="page-title">약 투입 (스캔)</h1>
  <p class="page-desc">카메라 중앙의 초록 박스(ROI)에 약봉투를 맞춘 뒤, 3연사 캡처로 인식합니다.</p>

  <div class="scan-grid">
    <div>
      <div class="cam-wrap">
        <video id="cam" autoplay playsinline muted></video>
        <div class="roi" id="roi"></div>
        <div class="hud">ROI 안에 약봉투를 정렬하세요. [C] 촬영, [Esc] 취소</div>
      </div>
      <div class="controls">
        <button class="btn" id="btnStart">카메라 시작</button>
        <button class="btn primary" id="btnShoot">3연사 촬영</button>
        <button class="btn" id="btnStop">중지</button>
      </div>
      <div class="thumbs" id="thumbs"></div>
      <div class="progress"><div class="bar" id="prog"></div></div>
    </div>

    <div class="result-card">
      <h2>결과</h2>
      <table class="data-table" id="tbl"></table>
      <h3 style="margin-top:16px">원시 응답(요약)</h3>
      <div class="mono" id="raw"></div>
    </div>
  </div>

  <!-- 업로드 폴백(파일 업로드로 1장 분석) -->
  <details style="margin-top:16px">
    <summary>파일 업로드로 분석하기</summary>
    <form id="uploadForm" class="upload-box" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="file" name="image" id="fileInput" accept="image/*,.pdf">
      <button type="submit" class="btn">업로드 분석</button>
    </form>
  </details>
</section>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const v = $("cam"), roi = $("roi"), thumbs = $("thumbs"), prog = $("prog"), tbl=$("tbl"), raw=$("raw");
  const btnStart=$("btnStart"), btnShoot=$("btnShoot"), btnStop=$("btnStop");
  let stream=null, raf=null;

  // ROI: 영상의 가운데 70%x55%
  function layoutROI(){
    const rW = 0.70, rH = 0.55, rX = 0.15, rY = 0.20; // scan.py와 동일 비율
    const rect = v.getBoundingClientRect();
    roi.style.left = (rect.width * rX) + "px";
    roi.style.top  = (rect.height* rY) + "px";
    roi.style.width  = (rect.width * rW) + "px";
    roi.style.height = (rect.height* rH) + "px";
  }
  window.addEventListener('resize', layoutROI);

  async function startCam(){
    if(stream) return;
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:false});
      v.srcObject = stream; v.onloadedmetadata = ()=>{ v.play(); layoutROI(); };
    }catch(e){ alert("카메라 접근 실패: "+e); }
  }
  function stopCam(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }

  function dataURLtoBlob(dataurl){
    const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]); let n = bstr.length; const u8 = new Uint8Array(n);
    while(n--){ u8[n] = bstr.charCodeAt(n); }
    return new Blob([u8], {type:mime});
  }

  function captureROI(){
    const r = roi.getBoundingClientRect();
    const vrect = v.getBoundingClientRect();
    const sx = (r.left - vrect.left) / vrect.width;
    const sy = (r.top  - vrect.top ) / vrect.height;
    const sw = r.width  / vrect.width;
    const sh = r.height / vrect.height;

    const vw = v.videoWidth, vh = v.videoHeight;
    const cx = Math.floor(vw * sx), cy = Math.floor(vh * sy);
    const cw = Math.floor(vw * sw), ch = Math.floor(vh * sh);

    const c = document.createElement('canvas');
    c.width = cw; c.height = ch;
    const ctx = c.getContext('2d');
    ctx.drawImage(v, cx, cy, cw, ch, 0, 0, cw, ch);
    return c.toDataURL('image/jpeg', 0.95);
  }

  async function shootBurst(){
    if(!stream){ await startCam(); }
    thumbs.innerHTML=''; prog.style.width='10%'; raw.textContent=''; tbl.innerHTML='';

    const imgs=[];
    for(let i=0;i<3;i++){
      const durl = captureROI();
      imgs.push(durl.replace(/^data:image\/(png|jpeg);base64,/,''));
      // 썸네일 표시
      const img = new Image(); img.src = durl; thumbs.appendChild(img);
      await new Promise(r=>setTimeout(r, 500)); // interval_s=0.5s
      prog.style.width = ((i+1)/3*60)+'%';
    }

    // 서버로 전송
    prog.style.width='70%';
    const res = await fetch('{% url "api_scan_envelope" %}',{
      method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
      body: JSON.stringify({ images: imgs })
    });
    const data = await res.json();
    prog.style.width='100%';

    if(!res.ok){ raw.textContent = JSON.stringify(data,null,2); return; }

    // 결과 테이블 렌더
    const m = data.merged || {};
    const rows = [
      ['환자명','patient_name'],['나이','age'],['조제일자','dispense_date'],['약국명','pharmacy_name'],
      ['처방/조제번호','prescription_number'],['약품명','medicine_name'],['복용법','dosage_instructions'],['기간/횟수','frequency'],
      ['한줄설명','med_features.description'],['적응증','med_features.indications'],['주의사항','med_features.cautions']
    ];
    tbl.innerHTML = '<thead><tr><th>항목</th><th>값</th></tr></thead><tbody>'+
      rows.map(([k,path])=>{
        const val = path.split('.').reduce((o,p)=>o?.[p], m) || '';
        return `<tr><td>${k}</td><td>${val}</td></tr>`;
      }).join('') + '</tbody>';

    raw.textContent = JSON.stringify({shots:data.shots?.map(s=>({keys:Object.keys(s.json||{}), path:s.image_path}))||[], merged:m}, null, 2);
  }

  // 업로드 폴백 (1장)
  const uploadForm = document.getElementById('uploadForm');
  if(uploadForm){
    uploadForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const f = document.getElementById('fileInput').files[0];
      if(!f){ alert('파일을 선택하세요'); return; }
      const b64 = await new Promise((resolve)=>{
        const r = new FileReader(); r.onload = ()=>resolve(r.result.split(',')[1]); r.readAsDataURL(f);
      });
      const res = await fetch('{% url "api_scan_envelope" %}',{
        method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
        body: JSON.stringify({ images: [b64] })
      });
      const data = await res.json();
      if(!res.ok){ raw.textContent = JSON.stringify(data,null,2); return; }
      const m = data.merged || {};
      tbl.innerHTML = `<thead><tr><th>항목</th><th>값</th></tr></thead><tbody>
        <tr><td>약품명</td><td>${m.medicine_name||''}</td></tr>
        <tr><td>복용법</td><td>${m.dosage_instructions||''}</td></tr>
      </tbody>`;
      raw.textContent = JSON.stringify(data,null,2);
    });
  }

  btnStart.onclick = startCam;
  btnStop.onclick  = ()=>{ stopCam(); };
  btnShoot.onclick = shootBurst;
  document.addEventListener('keydown', (ev)=>{
    if(ev.key==='c' || ev.key==='C'){ shootBurst(); }
    if(ev.key==='Escape'){ stopCam(); }
  });
})();
</script>
{% endblock %}

